<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runner's High - 프로토타입</title>

    <!-- 지도 API (Leaflet.js) 추가 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- 차트 API (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 폰트 및 기본 스타일 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

        :root {
            /* 테마 변수 선언 */
            --theme-bg: #f4f7fc;
            --theme-card-bg: #ffffff;
            --theme-header-bg: #0066FF;
            --theme-primary: #0066FF;
            --theme-secondary: #4CAF50;
            --theme-danger: #E63946;
            --theme-gold: #FFD700;
            --theme-text: #333333;
            --theme-light-text: #777777;
            --theme-border: #e0e0e0;
        }

        /* --- 테마별 색상 정의 --- */
        [data-theme="seed"] { --theme-bg: #f3f9f2; --theme-header-bg: #4CAF50; --theme-primary: #4CAF50; --theme-secondary: #66BB6A; }
        [data-theme="sprout"] { --theme-bg: #f0f7ff; --theme-header-bg: #007BFF; --theme-primary: #007BFF; --theme-secondary: #42A5F5; }
        [data-theme="flower"] { --theme-bg: #fdf2f8; --theme-header-bg: #9C27B0; --theme-primary: #9C27B0; --theme-secondary: #BA68C8; }
        [data-theme="tree"] { --theme-bg: #fff8e1; --theme-header-bg: #FFA000; --theme-primary: #FFA000; --theme-secondary: #FFC107; }
        [data-theme="forest"] { --theme-bg: #eef3f3; --theme-header-bg: #004D40; --theme-primary: #004D40; --theme-secondary: #26A69A; }


        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--theme-bg);
            color: var(--theme-text);
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            transition: background-color 0.5s ease;
        }

        .container {
            width: 100%; max-width: 420px;
            min-height: 100vh;
            background-color: var(--theme-card-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: background-color 0.5s ease;
        }

        /* 헤더 스타일 */
        header {
            background-color: var(--theme-header-bg);
            color: white; padding: 15px 20px;
            text-align: center; position: sticky;
            top: 0; z-index: 1000;
            transition: background-color 0.5s ease;
        }
        header h1 { margin: 0; font-size: 1.2em; }

        /* 네비게이션 바 스타일 */
        nav {
            display: flex; justify-content: space-around;
            background-color: var(--theme-card-bg);
            padding: 10px 0; border-bottom: 1px solid var(--theme-border);
            position: sticky; top: 57px; z-index: 999;
        }
        nav button {
            background: none; border: none; color: var(--theme-light-text);
            font-size: 0.8em; font-family: 'Noto Sans KR', sans-serif;
            padding: 10px 2px; cursor: pointer; border-bottom: 3px solid transparent;
            transition: color 0.3s, border-bottom-color 0.3s;
            flex-grow: 1; text-align: center;
        }
        nav button.active {
            color: var(--theme-primary); font-weight: 700;
            border-bottom-color: var(--theme-primary);
        }

        /* 메인 콘텐츠 영역 */
        main { padding: 20px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 카드 UI 스타일 */
        .card {
            background-color: var(--theme-card-bg);
            border-radius: 12px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--theme-border);
        }
        .card h2 { margin-top: 0; font-size: 1.2em; display: flex; align-items: center; }
        .card h2 .icon { margin-right: 10px; font-size: 1.5em; }
        .highlight { color: var(--theme-primary); font-weight: 700; }

        /* 레벨 및 목표 카드 스타일 */
        .level-card, .goal-card {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            transition: background 0.5s ease;
        }
        .level-card h2, .goal-card h2 { margin-bottom: 15px; font-size: 1.4em; }
        .progress-container {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px; height: 10px;
            width: 100%; overflow: hidden;
        }
        .progress-bar {
            background-color: white; height: 100%;
            width: 0%; border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }
        .progress-text {
            text-align: right; margin-top: 5px;
            font-size: 0.9em; font-weight: 500;
        }

        /* 대시보드 특정 스타일 */
        #dashboard-header { text-align: center; margin-bottom: 20px; }
        #dashboard-header h2 { font-size: 1.5em; margin: 0; }
        #dashboard-header p { color: var(--theme-light-text); margin-top: 5px; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-top: 20px; }
        .stat-item { padding: 10px; border-radius: 8px; transition: all 0.3s ease; }
        .stat-item p { margin: 5px 0 0; color: var(--theme-light-text); font-size: 0.9em;}
        .stat-item .value { font-size: 1.4em; font-weight: 700; }

        .recent-run-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid var(--theme-border); border-radius: 8px; margin-top: 10px; cursor: pointer; transition: background-color 0.3s; }
        .recent-run-item:hover { background-color: var(--theme-bg); }
        .run-info .date { font-weight: 500; }
        .run-info .details { font-size: 0.9em; color: var(--theme-light-text); }
        .run-cta { font-weight: 700; color: var(--theme-primary); }

        /* 리포트 및 인기코스 지도 스타일 */
        #report-header h2 { font-size: 1.4em; margin-bottom: 5px; }
        #report-header p { margin: 0; color: var(--theme-light-text); }
        #map, #popular-courses-map { width: 100%; height: 350px; border-radius: 8px; z-index: 1; }

        .feedback-card { background-color: #e8f5e9; border-left: 5px solid #4CAF50; }
        .feedback-card p { margin: 0; line-height: 1.6; }
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* 실시간 러닝 화면 스타일 */
        #realtime { text-align: center; }
        .location-info { text-align: center; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--theme-border); }
        .location-info .icon { font-size: 1.2em; margin-right: 8px; }
        .location-info .value { font-size: 1.2em; font-weight: 700; }
        .weather-info { display: flex; justify-content: space-around; align-items: center; }
        .weather-item { text-align: center; }
        .weather-item .icon { font-size: 2em; }
        .weather-item .value { font-size: 1.1em; font-weight: 700; margin-top: 5px; }
        .weather-item .label { font-size: 0.8em; color: var(--theme-light-text); }

        .realtime-stats-container { padding: 40px 20px; border: 2px solid var(--theme-border); border-radius: 12px; margin-bottom: 30px; }
        .realtime-stat { margin-bottom: 25px; }
        .realtime-stat:last-child { margin-bottom: 0; }
        .realtime-stat .label { font-size: 1.2em; color: var(--theme-light-text); }
        .realtime-stat .value { font-size: 3.5em; font-weight: 700; color: var(--theme-text); line-height: 1.1; }
        #start-stop-btn { width: 100%; padding: 15px; font-size: 1.2em; font-weight: 700; border-radius: 12px; border: none; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        #start-stop-btn.start { background-color: var(--theme-primary); color: white; }
        #start-stop-btn.stop { background-color: var(--theme-danger); color: white; }

        /* 챌린지 특정 스타일 */
        .leaderboard-toggle { display: flex; border: 1px solid var(--theme-primary); border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .leaderboard-toggle button { flex: 1; padding: 10px; background-color: white; color: var(--theme-primary); border: none; cursor: pointer; font-size: 1em; transition: background-color 0.3s, color 0.3s; }
        .leaderboard-toggle button.active { background-color: var(--theme-primary); color: white; }

        .leaderboard-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--theme-border); }
        .leaderboard-item:last-child { border-bottom: none; }
        .rank { font-size: 1.2em; font-weight: 700; width: 40px; color: var(--theme-light-text); }
        .rank.me { color: var(--theme-primary); }
        .user-info { flex-grow: 1; display: flex; align-items: center;}
        .user-info .name { font-weight: 500; }
        .user-info .name .me-tag { background-color: var(--theme-primary); color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
        .user-info .distance { color: var(--theme-light-text); font-size: 0.9em; }
        .user-level-icon { margin-right: 10px; font-size: 1.2em; }
        .representative-badge { margin-left: 5px; }
        .progress { font-size: 1.1em; font-weight: 700; }
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; text-align: center; }
        .badge-item { padding: 5px; border-radius: 8px; border: 2px solid transparent; transition: border-color 0.3s; }
        .badge-item.earned:hover { cursor: pointer; }
        .badge-item.selected { border-color: var(--theme-primary); }
        .badge-item .icon { font-size: 3em; filter: grayscale(1); opacity: 0.5; transition: all 0.3s; }
        .badge-item .icon.earned { filter: grayscale(0); opacity: 1; }
        .badge-item p { margin-top: 5px; font-size: 0.8em; color: var(--theme-light-text); }
        .badge-item p.earned { color: var(--theme-text); font-weight: 500;}

        /* 신발 관리 스타일 */
        .shoe-item, .retired-shoe-item { display: flex; align-items: center; padding: 10px; border: 1px solid var(--theme-border); border-radius: 8px; margin-bottom: 10px; }
        .shoe-icon { font-size: 2em; margin-right: 15px; }
        .shoe-info { flex-grow: 1; }
        .shoe-info .name { font-weight: 700; }
        .shoe-info .distance { color: var(--theme-light-text); font-size: 0.9em; }
        .retire-btn { padding: 5px 10px; border: 1px solid var(--theme-danger); color: var(--theme-danger); background-color: white; border-radius: 5px; cursor: pointer; }
        .retired-shoe-item { background-color: #fdfaf3; border-color: var(--theme-gold); }
        .retired-shoe-item .shoe-icon { color: var(--theme-gold); }

        /* 신발 선택 모달 스타일 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 12px; width: 80%; max-width: 350px; text-align: center; }
        .modal-content h3 { margin-top: 0; }
        .shoe-selection-item { display: flex; align-items: center; padding: 15px; border: 1px solid var(--theme-border); border-radius: 8px; margin-top: 10px; cursor: pointer; transition: background-color 0.3s; }
        .shoe-selection-item:hover { background-color: #f0f8ff; }

    </style>
</head>
<body>

<div class="container" data-theme="sprout">
    <header><h1>Runner's High</h1></header>

    <nav id="nav-bar">
        <button class="nav-btn active" data-target="dashboard">📈 대시보드</button>
        <button class="nav-btn" data-target="report">📄 운동 기록</button>
        <button class="nav-btn" data-target="realtime">🏃‍♂️ 실시간 러닝</button>
        <button class="nav-btn" data-target="courses">🗺️ 인기 코스</button>
        <button class="nav-btn" data-target="challenge">🏆 챌린지</button>
    </nav>

    <main>
        <!-- 대시보드 섹션 -->
        <div id="dashboard" class="section active">
            <div id="dashboard-header">
                <h2>안녕하세요, <span class="highlight">정다은</span>님!</h2>
                <p>오늘도 활기찬 하루를 시작해봐요.</p>
            </div>
            <!-- 레벨 정보 카드 -->
            <div class="card level-card">
                <h2><span id="level-icon"></span> <span id="level-name"></span></h2>
                <div class="progress-container">
                    <div class="progress-bar" id="level-progress-bar"></div>
                </div>
                <div class="progress-text">
                    <span id="level-current-km"></span> / <span id="level-next-km"></span> km
                </div>
            </div>
            <div class="card">
                <h2><span class="icon">📅</span> 주간 요약</h2>
                <div class="stats-grid">
                    <div class="stat-item"><div class="value" id="weekly-distance"></div><p>주간 거리</p></div>
                    <div class="stat-item"><div class="value" id="weekly-runs"></div><p>주간 러닝</p></div>
                    <div class="stat-item"><div class="value" id="weekly-pace"></div><p>평균 페이스</p></div>
                </div>
            </div>
            <!-- 주간 목표 카드 -->
            <div class="card goal-card">
                <h2><span class="icon">🎯</span> 주간 목표</h2>
                <div class="progress-container">
                    <div class="progress-bar" id="goal-progress-bar"></div>
                </div>
                <div class="progress-text">
                    <span id="goal-current-km"></span>km / <span id="goal-total-km"></span>km
                </div>
            </div>
            <div class="card"><h2><span class="icon">👟</span> 최근 운동 기록</h2><div id="recent-runs-list"></div></div>
            <div class="card">
                <h2><span class="icon">👟</span> 나의 러닝화</h2>
                <div id="active-shoes-list"></div>
                <h3 style="margin-top: 20px; font-size: 1.1em;">🏆 명예의 전당</h3>
                <div id="retired-shoes-list"></div>
            </div>
        </div>

        <!-- 운동 기록 섹션 -->
        <div id="report" class="section">
            <div class="card"><div id="report-header"><h2 id="report-title"></h2><p id="report-location"></p></div></div>
            <div class="card"><h2><span class="icon">🗺️</span> GPS 경로</h2><div id="map"></div></div>
            <div class="card"><h2><span class="icon">📊</span> 상세 데이터</h2><div class="stats-grid" id="report-stats-grid"></div></div>
            <div class="card"><h2><span class="icon">⏱️</span> 자동 페이스 분석</h2><div class="chart-container"><canvas id="paceChart"></canvas></div></div>
            <div class="card feedback-card"><h2><span class="icon">💡</span> 회복 가이드 및 피드백</h2><p id="report-feedback"></p></div>
        </div>

        <!-- 실시간 러닝 섹션 -->
        <div id="realtime" class="section">
            <!-- 날씨 정보 섹션 -->
            <div class="card">
                <div class="location-info">
                    <span class="icon">📍</span>
                    <span class="value" id="weather-location">날씨 로딩 중...</span>
                </div>
                <div class="weather-info">
                    <div class="weather-item">
                        <div class="icon" id="weather-icon"></div>
                        <div class="value" id="weather-temp"></div>
                        <div class="label">현재 기온</div>
                    </div>
                    <div class="weather-item">
                        <div class="icon" id="air-quality-icon"></div>
                        <div class="value" id="air-quality-value"></div>
                        <div class="label">미세먼지(PM2.5)</div>
                    </div>
                </div>
            </div>
            <div class="realtime-stats-container">
                <div class="realtime-stat"><div class="label">시간</div><div class="value" id="realtime-time">00:00</div></div>
                <div class="realtime-stat"><div class="label">거리 (km)</div><div class="value" id="realtime-distance">0.00</div></div>
                <div class="realtime-stat"><div class="label">현재 페이스</div><div class="value" id="realtime-pace">--'--"</div></div>
            </div>
            <button id="start-stop-btn" class="start">러닝 시작</button>
        </div>

        <!-- 인기 코스 섹션 -->
        <div id="courses" class="section">
            <div class="card">
                <h2><span class="icon">🔥</span> 러너들의 인기 스팟</h2>
                <p style="color: var(--theme-light-text); margin-top: -10px; margin-bottom: 20px;">
                    다른 사용자들이 가장 많이 달린 코스를 확인해보세요. 경로가 겹칠수록 진하게 표시됩니다.
                </p>
                <div id="popular-courses-map"></div>
            </div>
        </div>

        <!-- 챌린지 섹션 -->
        <div id="challenge" class="section">
            <div class="card">
                <h2><span class="icon">🔥</span> 그룹 챌린지: 주간 최장거리</h2>
                <div class="leaderboard-toggle">
                    <button id="friends-btn" class="active">친구</button>
                    <button id="local-btn">동네 러너</button>
                </div>
                <div id="leaderboard"></div>
            </div>
            <div class="card"><h2><span class="icon">🏅</span> 나의 배지</h2><div class="badge-grid" id="badge-gallery"></div></div>
        </div>
    </main>
</div>

<!-- 신발 선택 모달 -->
<div id="shoe-selection-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>어떤 신발을 신으셨나요?</h3>
        <div id="shoe-selection-list"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 시뮬레이션 데이터 ---
        const userData = {
            name: "정다은",
            totalDistance: 31.0,
            representativeBadge: "7일 연속 달성", // 대표 배지 추가
            weeklySummary: { distance: 13.5, runs: 2, avgPace: "6'15\"" },
            weeklyGoal: 15,
            shoes: [
                { id: 101, name: '페가수스 40', totalDistance: 120.5, status: 'active', icon: '👟' },
                { id: 102, name: '인피니티 런 4', totalDistance: 55.2, status: 'active', icon: '💨' },
                { id: 103, name: '베이퍼플라이 2', totalDistance: 450.8, status: 'retired', icon: '🏆' },
            ],
            recentRuns: [
                { id: 1, shoeId: 101, date: "7월 1일", location: "저녁, 석촌호수 서호", distance: 5.2, time: "31:15", pace: "6'00\"", cadence: 165, heartRate: 158, elevation: 25, paceByKm: ["6'10\"", "6'05\"", "5'50\"", "6'00\"", "5'55\""], path: [[37.5084, 127.1013], [37.5095, 127.1000], [37.5110, 127.1015], [37.5100, 127.1030]] },
                { id: 2, shoeId: 102, date: "6월 28일", location: "아침, 석촌호수 동호", distance: 8.3, time: "52:30", pace: "6'20\"", cadence: 162, heartRate: 155, elevation: 40, paceByKm: ["6'30\"", "6'25\"", "6'20\"", "6'15\"", "6'10\"", "6'18\"", "6'22\"", "6'25\""], path: [[37.5115, 127.1055], [37.5125, 127.1070], [37.5110, 127.1085], [37.5095, 127.1065]] },
                { id: 3, shoeId: 101, date: "6월 25일", location: "저녁, 올림픽공원 평화의 광장", distance: 10.0, time: "01:01:00", pace: "6'06\"", cadence: 164, heartRate: 157, elevation: 15, paceByKm: [], path: [[37.5213, 127.1218], [37.5225, 127.1230], [37.5238, 127.1255], [37.5220, 127.1260]] },
                { id: 4, shoeId: 101, date: "6월 22일", location: "저녁, 올림픽공원 몽촌토성", distance: 7.5, time: "45:30", pace: "6'04\"", cadence: 166, heartRate: 160, elevation: 20, paceByKm: [], path: [[37.5180, 127.1160], [37.5195, 127.1175], [37.5185, 127.1190], [37.5170, 127.1180]] }
            ],
            challenges: {
                friends: [
                    { id: 201, name: "이수진", totalDistance: 162.4, weeklyDistance: 16.2, isMe: false, representativeBadge: "첫 10K 완주" },
                    { id: 202, name: "김민준", totalDistance: 455.1, weeklyDistance: 11.8, isMe: false, representativeBadge: "첫 풀코스" }
                ],
                localRunners: [
                    { id: 301, name: "잠실동 고수", totalDistance: 750.2, weeklyDistance: 50.1, isMe: false, representativeBadge: "7대 마라톤 완주" },
                    { id: 302, name: "송파구 러너", totalDistance: 310.8, weeklyDistance: 25.5, isMe: false, representativeBadge: "첫 하프코스" },
                    { id: 303, name: "석촌호수 지박령", totalDistance: 480.0, weeklyDistance: 30.0, isMe: false, representativeBadge: null },
                ]
            },
            badges: [
                { name: "첫 달리기", icon: "🎉", earned: true },
                { name: "첫 5K 완주", icon: "👟", earned: true },
                { name: "꾸준한 러너", icon: "📅", earned: true },
                { name: "야간 러너", icon: "🌙", earned: true },
                { name: "7일 연속 달성", icon: "🗓️", earned: true },
                { name: "아침형 인간", icon: "☀️", earned: true },
                { name: "첫 10K 완주", icon: "🚀", earned: false },
                { name: "첫 하프코스", icon: "🏃‍♀️", earned: false },
                { name: "첫 풀코스", icon: "🏁", earned: false },
                { name: "산악 러너", icon: "⛰️", earned: false },
                { name: "주말의 전사", icon: "😎", earned: false },
                { name: "장거리 마스터", icon: "🏅", earned: false },
                { name: "신발 수집가", icon: "👑", earned: false },
                { name: "비오는 날 러너", icon: "🌧️", earned: false },
                { name: "눈 오는날 러너", icon: "❄️", earned: false },
                { name: "7대 마라톤 완주", icon: "🌍", earned: false },
            ]
        };

        // --- 전역 변수 ---
        let paceChartInstance = null;
        let mapInstance = null;
        let popularCoursesMapInstance = null;
        let isRunning = false;
        let runTimer = null;
        let currentRunData = {};

        // --- DOM 요소 ---
        const startStopBtn = document.getElementById('start-stop-btn');
        const shoeSelectionModal = document.getElementById('shoe-selection-modal');

        // --- 헬퍼 함수 ---
        const formatTime = (seconds) => {
            const min = Math.floor(seconds / 60).toString().padStart(2, '0');
            const sec = (seconds % 60).toString().padStart(2, '0');
            return `${min}:${sec}`;
        };
        const formatPace = (secondsPerKm) => {
            if (isNaN(secondsPerKm) || !isFinite(secondsPerKm) || secondsPerKm === 0) return "--'--\"";
            const min = Math.floor(secondsPerKm / 60);
            const sec = Math.round(secondsPerKm % 60).toString().padStart(2, '0');
            return `${min}'${sec}"`;
        };

        // --- 네비게이션 로직 ---
        const navBar = document.getElementById('nav-bar');
        navBar.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.nav-btn');
            if (!targetBtn) return;
            navigateTo(targetBtn.dataset.target);
        });

        function navigateTo(targetId, runId = null) {
            const navBtns = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.section');
            const targetBtn = document.querySelector(`.nav-btn[data-target="${targetId}"]`);
            if (!targetBtn) return;

            navBtns.forEach(btn => btn.classList.remove('active'));
            targetBtn.classList.add('active');

            if (targetId === 'report' && runId) {
                const runData = userData.recentRuns.find(run => run.id === runId);
                if (runData) renderReport(runData);
            }

            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetId) section.classList.add('active');
            });

            if (targetId === 'courses' && !popularCoursesMapInstance) {
                renderPopularCoursesMap();
            }

            // 지도 리사이징 처리
            setTimeout(() => {
                if (targetId === 'report' && mapInstance) {
                    mapInstance.invalidateSize();
                    if (mapInstance.currentBounds) {
                        mapInstance.fitBounds(mapInstance.currentBounds.pad(0.1));
                    }
                } else if (targetId === 'courses' && popularCoursesMapInstance) {
                    popularCoursesMapInstance.invalidateSize();
                }
            }, 10);
        }

        // --- 실시간 러닝 로직 ---
        startStopBtn.addEventListener('click', () => {
            if (!isRunning) startRun();
            else finishRun();
        });

        function startRun() {
            isRunning = true;
            startStopBtn.textContent = '러닝 종료';
            startStopBtn.className = 'stop';
            currentRunData = { id: Date.now(), startTime: new Date(), elapsedSeconds: 0, distance: 0, path: [[37.5115, 127.1055]], paceByKm: [] };
            runTimer = setInterval(updateRun, 1000);
        }

        function updateRun() {
            currentRunData.elapsedSeconds++;
            const lastDistance = currentRunData.distance;
            const distanceIncrement = (Math.random() * 2 + 2) / 1000;
            currentRunData.distance += distanceIncrement;
            const currentPace = currentRunData.elapsedSeconds / currentRunData.distance;
            const lastCoord = currentRunData.path[currentRunData.path.length - 1];
            const newLat = lastCoord[0] + (Math.random() - 0.5) * 0.0001;
            const newLon = lastCoord[1] + (Math.random() - 0.5) * 0.0001;
            currentRunData.path.push([newLat, newLon]);
            if (Math.floor(currentRunData.distance) > Math.floor(lastDistance)) {
                const km = Math.floor(currentRunData.distance);
                const timeAtLastKm = currentRunData.paceByKm.reduce((acc, curr) => acc + curr.time, 0) || 0;
                const thisKmTime = currentRunData.elapsedSeconds - timeAtLastKm;
                currentRunData.paceByKm.push({ km: km, time: thisKmTime });
            }
            document.getElementById('realtime-time').textContent = formatTime(currentRunData.elapsedSeconds);
            document.getElementById('realtime-distance').textContent = currentRunData.distance.toFixed(2);
            document.getElementById('realtime-pace').textContent = formatPace(currentPace);
        }

        function finishRun() {
            isRunning = false;
            clearInterval(runTimer);
            startStopBtn.textContent = '러닝 시작';
            startStopBtn.className = 'start';
            showShoeSelectionModal();
        }

        // --- 신발 관리 로직 ---
        function showShoeSelectionModal() {
            const shoeList = document.getElementById('shoe-selection-list');
            shoeList.innerHTML = '';
            userData.shoes.filter(s => s.status === 'active').forEach(shoe => {
                const item = document.createElement('div');
                item.className = 'shoe-selection-item';
                item.innerHTML = `<span class="shoe-icon">${shoe.icon}</span> <span class="shoe-name">${shoe.name}</span>`;
                item.addEventListener('click', () => selectShoeForRun(shoe.id));
                shoeList.appendChild(item);
            });
            shoeSelectionModal.style.display = 'flex';
        }

        function selectShoeForRun(shoeId) {
            shoeSelectionModal.style.display = 'none';
            const now = new Date();
            const runDistance = parseFloat(currentRunData.distance.toFixed(2));
            const newRun = {
                id: currentRunData.id, shoeId: shoeId,
                date: `${now.getMonth() + 1}월 ${now.getDate()}일`,
                location: "방금, 실시간 러닝", distance: runDistance,
                time: formatTime(currentRunData.elapsedSeconds),
                pace: formatPace(currentRunData.elapsedSeconds / currentRunData.distance),
                cadence: Math.floor(Math.random() * 10 + 160),
                heartRate: Math.floor(Math.random() * 20 + 150),
                elevation: Math.floor(Math.random() * 20 + 10),
                paceByKm: currentRunData.paceByKm.map(p => formatPace(p.time)),
                path: currentRunData.path
            };
            userData.recentRuns.unshift(newRun);
            userData.totalDistance += runDistance;
            const shoe = userData.shoes.find(s => s.id === shoeId);
            if (shoe) shoe.totalDistance += runDistance;
            userData.weeklySummary.distance += runDistance;
            userData.weeklySummary.runs++;
            renderDashboard();
            navigateTo('report', newRun.id);
            document.getElementById('realtime-time').textContent = '00:00';
            document.getElementById('realtime-distance').textContent = '0.00';
            document.getElementById('realtime-pace').textContent = "--'--\"";
        }

        function retireShoe(shoeId) {
            const shoe = userData.shoes.find(s => s.id === shoeId);
            if (shoe) { shoe.status = 'retired'; renderShoes(); }
        }

        function renderShoes() {
            const activeList = document.getElementById('active-shoes-list');
            const retiredList = document.getElementById('retired-shoes-list');
            activeList.innerHTML = ''; retiredList.innerHTML = '';
            userData.shoes.forEach(shoe => {
                if (shoe.status === 'active') {
                    const item = document.createElement('div');
                    item.className = 'shoe-item';
                    item.innerHTML = `<span class="shoe-icon">${shoe.icon}</span><div class="shoe-info"><div class="name">${shoe.name}</div><div class="distance">총 ${shoe.totalDistance.toFixed(1)} km</div></div><button class="retire-btn">은퇴</button>`;
                    item.querySelector('.retire-btn').addEventListener('click', () => retireShoe(shoe.id));
                    activeList.appendChild(item);
                } else {
                    const item = document.createElement('div');
                    item.className = 'retired-shoe-item';
                    item.innerHTML = `<span class="shoe-icon">${shoe.icon}</span><div class="shoe-info"><div class="name">${shoe.name}</div><div class="distance">총 ${shoe.totalDistance.toFixed(1)} km와 함께한 추억</div></div>`;
                    retiredList.appendChild(item);
                }
            });
        }

        // --- 레벨 및 테마 업데이트 로직 ---
        const levelTiers = [
            { level: 0, name: '씨앗 러너', threshold: 0, theme: 'seed', icon: '🌱' },
            { level: 1, name: '새싹 러너', threshold: 150, theme: 'sprout', icon: '🌿' },
            { level: 2, name: '꽃길 러너', threshold: 300, theme: 'flower', icon: '🌸' },
            { level: 3, name: '나무 러너', threshold: 450, theme: 'tree', icon: '🌳' },
            { level: 4, name: '숲의 지배자', threshold: 600, theme: 'forest', icon: '🌲' }
        ];

        function getTier(distance) {
            return [...levelTiers].reverse().find(tier => distance >= tier.threshold);
        }

        function updateLevelAndTheme(totalDistance) {
            const currentTier = getTier(totalDistance);
            const nextTier = levelTiers.find(tier => tier.level === currentTier.level + 1);

            document.querySelector('.container').dataset.theme = currentTier.theme;
            document.getElementById('level-icon').textContent = currentTier.icon;
            document.getElementById('level-name').textContent = `Lv.${currentTier.level} ${currentTier.name}`;

            const progressInLevel = totalDistance - currentTier.threshold;
            const neededForNextLevel = nextTier ? nextTier.threshold - currentTier.threshold : progressInLevel;
            const progressPercentage = nextTier ? (progressInLevel / neededForNextLevel) * 100 : 100;

            document.getElementById('level-progress-bar').style.width = `${progressPercentage}%`;
            document.getElementById('level-current-km').textContent = totalDistance.toFixed(1);
            document.getElementById('level-next-km').textContent = nextTier ? nextTier.threshold : totalDistance.toFixed(1);
        }

        // --- 날씨 및 미세먼지 API 연동 ---
        async function fetchWeatherAndAirQuality(lat, lon, locationName) {
            const weatherURL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code,temperature_2m`;
            const airQualityURL = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=pm2_5`;

            try {
                const [weatherResponse, airQualityResponse] = await Promise.all([
                    fetch(weatherURL),
                    fetch(airQualityURL)
                ]);

                const weatherData = await weatherResponse.json();
                const airQualityData = await airQualityResponse.json();

                updateWeatherUI(weatherData.current, locationName);
                updateAirQualityUI(airQualityData.current);

            } catch (error) {
                console.error("날씨 정보 로딩 실패:", error);
                document.getElementById('weather-location').textContent = "날씨 정보 로딩 실패";
            }
        }

        async function getLocationName(lat, lon) {
            // [FIX] Using a reliable reverse geocoding service (Nominatim)
            const geocodingURL = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=ko`;
            try {
                const response = await fetch(geocodingURL);
                const data = await response.json();
                if (data && data.address) {
                    return data.address.suburb || data.address.city_district || data.address.city || '현재 위치';
                }
                return '알 수 없는 위치';
            } catch (error) {
                console.error("Geocoding error:", error);
                return '위치 확인 불가';
            }
        }


        function updateWeatherUI(currentWeather, locationName) {
            const temp = Math.round(currentWeather.temperature_2m);
            const weatherCode = currentWeather.weather_code;

            const getWeatherIcon = (code) => {
                if (code === 0) return '☀️';
                if (code >= 1 && code <= 3) return '🌤️';
                if (code >= 45 && code <= 48) return '🌫️';
                if (code >= 51 && code <= 67) return '🌧️';
                if (code >= 71 && code <= 77) return '❄️';
                if (code >= 80 && code <= 82) return '🌦️';
                if (code >= 95 && code <= 99) return '⛈️';
                return '☁️';
            };

            document.getElementById('weather-icon').textContent = getWeatherIcon(weatherCode);
            document.getElementById('weather-temp').textContent = `${temp}°C`;
            document.getElementById('weather-location').textContent = locationName;
        }

        function updateAirQualityUI(currentAirQuality) {
            const pm25 = Math.round(currentAirQuality.pm2_5);

            const getAirQualityInfo = (value) => {
                if (value <= 15) return { icon: '😊', text: '좋음' };
                if (value <= 35) return { icon: '😐', text: '보통' };
                if (value <= 75) return { icon: '😷', text: '나쁨' };
                return { icon: '😱', text: '매우 나쁨' };
            };

            const airInfo = getAirQualityInfo(pm25);
            document.getElementById('air-quality-icon').textContent = airInfo.icon;
            document.getElementById('air-quality-value').textContent = `${airInfo.text} (${pm25})`;
        }

        // --- 렌더링 함수 ---
        function renderDashboard() {
            updateLevelAndTheme(userData.totalDistance);

            document.getElementById('weekly-distance').textContent = `${userData.weeklySummary.distance.toFixed(1)}km`;
            document.getElementById('weekly-runs').textContent = `${userData.weeklySummary.runs}회`;
            document.getElementById('weekly-pace').textContent = userData.weeklySummary.avgPace;

            const goalCurrentKm = document.getElementById('goal-current-km');
            const goalTotalKm = document.getElementById('goal-total-km');
            const goalProgressBar = document.getElementById('goal-progress-bar');

            goalCurrentKm.textContent = userData.weeklySummary.distance.toFixed(1);
            goalTotalKm.textContent = userData.weeklyGoal;
            const goalProgress = (userData.weeklySummary.distance / userData.weeklyGoal) * 100;
            goalProgressBar.style.width = `${Math.min(goalProgress, 100)}%`;

            const runsList = document.getElementById('recent-runs-list');
            runsList.innerHTML = '';
            userData.recentRuns.forEach(run => {
                const runItem = document.createElement('div');
                runItem.className = 'recent-run-item';
                runItem.innerHTML = `<div class="run-info"><div class="date">${run.date}</div><div class="details">${run.distance}km / ${run.time} / ${run.pace}</div></div><div class="run-cta">리포트 보기 ></div>`;
                runItem.addEventListener('click', () => navigateTo('report', run.id));
                runsList.appendChild(runItem);
            });
            renderShoes();
        }

        function renderReport(runData) {
            document.getElementById('report-title').textContent = `${runData.date} 운동 기록`;
            document.getElementById('report-location').textContent = runData.location;
            const statsGrid = document.getElementById('report-stats-grid');
            statsGrid.innerHTML = `<div class="stat-item"><div class="value">${runData.distance}km</div><p>거리</p></div><div class="stat-item"><div class="value">${runData.time}</div><p>시간</p></div><div class="stat-item"><div class="value">${runData.pace}</div><p>평균 페이스</p></div><div class="stat-item"><div class="value">${runData.cadence}spm</div><p>평균 케이던스</p></div><div class="stat-item"><div class="value">${runData.heartRate}bpm</div><p>평균 심박수</p></div><div class="stat-item"><div class="value">${runData.elevation}m</div><p>고도 상승</p></div>`;
            document.getElementById('report-feedback').innerHTML = `<strong>👍 정말 멋진 러닝이었어요, ${userData.name}님!</strong><br>운동 강도를 고려했을 때, <strong>24시간의 충분한 휴식</strong>을 권장해요. 가벼운 스트레칭으로 마무리하는 것도 잊지 마세요!`;
            renderMap(runData);
            renderPaceChart(runData);
        }

        function renderMap(runData) {
            if (mapInstance) { mapInstance.remove(); mapInstance = null; }
            mapInstance = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(mapInstance);
            if (runData.path && runData.path.length > 0) {
                const polyline = L.polyline(runData.path, { color: 'var(--theme-danger)', weight: 5 }).addTo(mapInstance);
                L.marker(runData.path[0]).addTo(mapInstance).bindPopup('출발점');
                L.marker(runData.path[runData.path.length - 1]).addTo(mapInstance).bindPopup('도착점');
                mapInstance.currentBounds = polyline.getBounds();
                mapInstance.fitBounds(mapInstance.currentBounds.pad(0.1));
            } else { mapInstance.setView([37.5115, 127.1055], 14); }
        }

        function renderPopularCoursesMap() {
            if (popularCoursesMapInstance) {
                popularCoursesMapInstance.remove();
                popularCoursesMapInstance = null;
            }
            popularCoursesMapInstance = L.map('popular-courses-map').setView([37.5115, 127.1055], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(popularCoursesMapInstance);

            userData.recentRuns.forEach(run => {
                if (run.path && run.path.length > 0) {
                    L.polyline(run.path, {
                        color: 'rgba(230, 57, 70, 0.4)',
                        weight: 3,
                        interactive: false
                    }).addTo(popularCoursesMapInstance);
                }
            });
        }

        function renderPaceChart(runData) {
            const ctx = document.getElementById('paceChart').getContext('2d');
            if (paceChartInstance) paceChartInstance.destroy();
            const paceDataInSeconds = (runData.paceByKm || []).map(p => {
                const parts = p.replace('"', '').split("'");
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            });
            const labels = Array.from({length: paceDataInSeconds.length}, (_, i) => `${i + 1}km`);
            paceChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '구간별 페이스', data: paceDataInSeconds, backgroundColor: 'rgba(0, 102, 255, 0.1)', borderColor: 'var(--theme-primary)', borderWidth: 2, tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { reverse: true, ticks: { callback: (value) => formatPace(value) } } }, plugins: { tooltip: { callbacks: { label: (context) => `페이스: ${formatPace(context.raw)}` } } } }
            });
        }

        function renderChallenges() {
            const friendsBtn = document.getElementById('friends-btn');
            const localBtn = document.getElementById('local-btn');

            const renderLeaderboard = (list) => {
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '';

                const selfData = {
                    id: 0, name: userData.name,
                    totalDistance: userData.totalDistance,
                    weeklyDistance: userData.weeklySummary.distance,
                    isMe: true, representativeBadge: userData.representativeBadge
                };
                const combinedList = [...list, selfData].sort((a,b) => b.weeklyDistance - a.weeklyDistance);

                combinedList.forEach((runner, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';

                    const tier = getTier(runner.totalDistance);
                    const representativeBadge = userData.badges.find(b => b.name === runner.representativeBadge);

                    item.innerHTML = `
                            <div class="rank ${runner.isMe ? 'me' : ''}">${index + 1}</div>
                            <div class="user-info">
                                <span class="user-level-icon">${tier.icon}</span>
                                <div>
                                    <span class="name">
                                        ${runner.name}
                                        <span class="representative-badge">${representativeBadge ? representativeBadge.icon : ''}</span>
                                        ${runner.isMe ? '<span class="me-tag">나</span>' : ''}
                                    </span>
                                    <div class="distance">주간 ${runner.weeklyDistance.toFixed(1)}km</div>
                                </div>
                            </div>
                            <div class="progress">🔥</div>`;
                    leaderboard.appendChild(item);
                });
            };

            friendsBtn.addEventListener('click', () => {
                friendsBtn.classList.add('active');
                localBtn.classList.remove('active');
                renderLeaderboard(userData.challenges.friends);
            });

            localBtn.addEventListener('click', () => {
                localBtn.classList.add('active');
                friendsBtn.classList.remove('active');
                renderLeaderboard(userData.challenges.localRunners);
            });

            renderLeaderboard(userData.challenges.friends);

            const badgeGallery = document.getElementById('badge-gallery');
            badgeGallery.innerHTML = '';
            const sortedBadges = [...userData.badges].sort((a, b) => b.earned - a.earned);

            sortedBadges.forEach(badge => {
                const item = document.createElement('div');
                const earnedClass = badge.earned ? 'earned' : '';
                item.className = 'badge-item';
                if (badge.earned) {
                    item.classList.add('earned');
                }
                if (badge.name === userData.representativeBadge) {
                    item.classList.add('selected');
                }
                item.innerHTML = `<div class="icon ${earnedClass}">${badge.icon}</div><p class="${earnedClass}">${badge.name}</p>`;

                if (badge.earned) {
                    item.addEventListener('click', () => {
                        userData.representativeBadge = badge.name;
                        renderChallenges(); // Re-render to show selection and update leaderboard
                    });
                }
                badgeGallery.appendChild(item);
            });
        }

        function calculateTotalDistance() {
            return userData.recentRuns.reduce((total, run) => total + run.distance, 0);
        }

        // --- 앱 초기화 ---
        function initializeApp() {
            userData.totalDistance = calculateTotalDistance();
            renderDashboard();
            if (userData.recentRuns.length > 0) renderReport(userData.recentRuns[0]);
            renderChallenges();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    const locationName = await getLocationName(latitude, longitude);
                    fetchWeatherAndAirQuality(latitude, longitude, locationName);
                }, error => {
                    console.warn("Geolocation error:", error.message, ". Falling back to default location.");
                    fetchWeatherAndAirQuality(37.5665, 126.9780, '서울 (위치 정보 실패)');
                });
            } else {
                console.warn("Geolocation is not supported by this browser. Falling back to default location.");
                fetchWeatherAndAirQuality(37.5665, 126.9780, '서울 (위치 정보 미지원)');
            }

            navigateTo('dashboard');
        }

        initializeApp();
    });
</script>

</body>
</html>
